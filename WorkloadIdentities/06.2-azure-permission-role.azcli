# In this scenario, the workload identity is granted an Azure role
# which allows it to grant any role to any other identity.

#################### PREREQUISITES ####################

# The commands below should be executed in bash with the following prerequisites installed
# (note that these are all preinstalled on Azure Cloud Shell):
# - Azure CLI (https://docs.microsoft.com/cli/azure/install-azure-cli)
# - curl
# - jq

#################### ADMINISTRATOR ####################

# Set configuration variables.
TENANT_ID=MSDx413347.onmicrosoft.com
PREFIX=WI-
RESOURCEGROUP_NAME="$PREFIX"ResourceGroup
REGION="westeurope"

# Login interactively.
az login --tenant $TENANT_ID

# Create the Service Principal representing the Workload Identity.
WORKLOAD_SP=$(az ad sp create-for-rbac --name "$PREFIX"WorkloadIdentity)
WORKLOAD_APPID=$(echo $WORKLOAD_SP | jq -r .appId)
WORKLOAD_SP_OBJECTID=$(az ad sp list --filter "appId eq '$WORKLOAD_APPID'" --query "[0].id" -o tsv)
WORKLOAD_SP_PASSWORD=$(echo $WORKLOAD_SP | jq -r .password)
echo "Workload Identity Service Principal created: App ID '$WORKLOAD_APPID', Object ID '$WORKLOAD_SP_OBJECTID'."

# Create a resource group to allow the Workload Identity to deploy into.
RESOURCEGROUP=$(az group create --name $RESOURCEGROUP_NAME --location $REGION)
RESOURCEGROUP_ID=$(echo $RESOURCEGROUP | jq -r .id)

# Add the Workload Identity as a Contributor to the resource group so it can deploy resources.
az role assignment create --assignee-object-id $WORKLOAD_SP_OBJECTID --assignee-principal-type ServicePrincipal --role Contributor --scope $RESOURCEGROUP_ID

# Grant the Workload Identity the User Access Administrator role so it can assign permissions within the resource group.
az role assignment create --assignee-object-id $WORKLOAD_SP_OBJECTID --assignee-principal-type ServicePrincipal --role "User Access Administrator" --scope $RESOURCEGROUP_ID

#################### WORKLOAD IDENTITY ####################

# Log in to the Azure CLI as the Workload Identity.
az login --service-principal --username $WORKLOAD_APPID --password $WORKLOAD_SP_PASSWORD --tenant $TENANT_ID

# Create a Storage Account using the Contributor permissions on the resource group.
STORAGEACCOUNT_NAME="$PREFIX"storage"$RANDOM"
STORAGEACCOUNT_NAME=${STORAGEACCOUNT_NAME,,} # Convert to lowercase.
STORAGEACCOUNT_NAME=${STORAGEACCOUNT_NAME//[^[:alnum:]]/} # Remove any non-alphanumeric characters.
STORAGEACCOUNT=$(az storage account create --name $STORAGEACCOUNT_NAME --resource-group $RESOURCEGROUP_NAME --sku Standard_LRS)
STORAGEACCOUNT_RESOURCE_ID=$(echo $STORAGEACCOUNT | jq -r .id)

# Create a user-assigned managed identity which needs access to the Storage Account.
UAMI=$(az identity create --name "$PREFIX"ManagedIdentity --resource-group $RESOURCEGROUP_NAME)
UAMI_RESOURCE_ID=$(echo $UAMI | jq -r .id)
UAMI_SP_OBJECTID=$(echo $UAMI | jq -r .principalId)

# Grant the user-assigned managed identity access to the Storage Account.
az role assignment create --assignee-object-id $UAMI_SP_OBJECTID --assignee-principal-type ServicePrincipal --role "Storage Blob Data Contributor" --scope $STORAGEACCOUNT_RESOURCE_ID

# Remove the user-assigned managed identity.
az identity delete --ids $UAMI_RESOURCE_ID

# Remove the Storage Account.
az storage account delete --name $STORAGEACCOUNT_NAME --resource-group $RESOURCEGROUP_NAME --yes

#################### ADMINISTRATOR ####################

# Since the Workload Identity was logged in to the Azure CLI, login interactively again.
az login --tenant $TENANT_ID

# Remove the resource group.
az group delete --name $RESOURCEGROUP_NAME --yes

# Remove the Workload Identity.
az ad app delete --id $WORKLOAD_APPID
